# ПЛАН РЕФАКТОРИНГА ПРОЕКТА КРИПТОАНАЛИЗА (ВАРИАНТ 5)

## ЭТАП 1: ОБЩАЯ ПОДГОТОВКА И КОНСТАНТЫ
Цель: Исправить определения данных и таблиц подстановки, чтобы они соответствовали 4-битной архитектуре.

- [x] **Замена S-блока (S-box):** комментарий: Реализовано в `zmak.h` (массив `SBOX`).
- [x] **Настройка ключей:** комментарий: Реализовано в `zmak.h` (массив `ROUND_KEYS`, 6 ключей).
- [x] **Изменение структуры блока данных:** комментарий: Реализована `struct Block` с 4 нибблами в `zmak.h`.

## ЭТАП 2: ЯДРО ШИФРОВАНИЯ (CORE LOGIC)
Цель: Реализовать логику Generalized Feistel Network (Type-2) вместо классического Feistel.

- [x] **Реализация функции раунда (F):** комментарий: Реализована `inline uint8_t F(...)` в `zmak.h`.
- [x] **Функция полного шифрования (encryptFull):** комментарий: Реализована `inline void encrypt(Block& b)` в `zmak.h` (6 раундов).

## ЭТАП 3: РЕФАКТОРИНГ ГЕНЕРАТОРА (generator_of_data.cpp)
Цель: Адаптировать генерацию пар под 4-компонентный вектор.

- [x] **Обновление перебора открытых текстов:** комментарий: Теперь перебираются 16-битные блоки, разделенные на 4 ниббла.
- [x] **Обновление генерации разностей (Differentials):** комментарий: dX теперь перебирается как 16-битное число, разделяемое на 4 ниббла (0..15 каждый).
- [x] **Формат вывода в файл:** комментарий: В `pairs_data.txt` записываются 16 значений (X, dX, Y, Yp) по 4 компоненты на каждый вектор.

## ЭТАП 4: РЕФАКТОРИНГ АНАЛИЗАТОРА (analysis_attack.cpp)
Цель: Поиск характеристик для 5 раундов новой схемы.

- [x] **Адаптация парсера:** комментарий: Читает 16 значений из `pairs_data.txt`.
- [x] **Изменение глубины шифрования:** комментарий: Использует `encryptRounds(..., 5)`.
- [x] **Сбор статистики:** комментарий: Статистика собирается для `map<uint16_t, ...>` (упакованные dY). Результаты пишутся в `diff_round_5_top.txt`.

## ЭТАП 5: РЕФАКТОРИНГ АТАКИ (attack_last_round.cpp)
Цель: Реализовать откат последнего раунда для новой схемы.

- [x] **Ввод целевых характеристик:** комментарий: Константы `T_dX` и `T_dY` обновлены реальными значениями из анализа.
- [x] **Реализация функции частичного дешифрования (StepBack):** комментарий: Используется `decryptOneRound` из `zmak.h`.
- [x] **Перебор ключа:** комментарий: Перебираются ключи 0..15. Атака успешно находит верный ключ (0xB).

## ЭТАП 6: ПРОВЕРКА И ОТЛАДКА
- [x] Проверить, что программа не падает (нет выхода за границы массива G). комментарий: Код стабилен, сегфолтов нет.
- [x] Убедиться, что при нулевой разности на входе (`dX=0`) разность на выходе тоже нулевая (Sanity Check). комментарий: Подтверждено анализом (dX=0 -> dY=0, p=1.0).
- [x] Запустить генератор -> анализатор -> атаку и проверить, находится ли зашитый ключ. комментарий: Ключ 11 (0xB) найден в топе результатов.
